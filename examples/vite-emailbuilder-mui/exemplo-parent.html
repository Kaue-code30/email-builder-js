<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exemplo - Parent com Email Builder</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .controls {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    button {
      background: #0066FF;
      color: white;
      border: none;
      padding: 12px 24px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #0052CC;
    }
    button.secondary {
      background: #6c757d;
    }
    button.secondary:hover {
      background: #5a6268;
    }
    #status {
      margin-top: 15px;
      padding: 12px;
      background: #fff;
      border-left: 4px solid #0066FF;
      border-radius: 4px;
    }
    iframe {
      width: 100%;
      height: 800px;
      border: 2px solid #ddd;
      border-radius: 8px;
    }
    h1 {
      margin-top: 0;
      color: #333;
    }
    .info {
      color: #666;
      font-size: 14px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé® Email Builder - Integra√ß√£o Parent</h1>
    <p class="info">
      Exemplo de como carregar HTML do banco de dados no iframe e receber o HTML editado.
    </p>

    <div class="controls">
      <div>
        <button id="loadSimple">üìß Carregar Email Simples</button>
        <button id="loadFromDB">üíæ Simular Carregar do Banco</button>
        <button id="saveHTML" class="secondary">üíæ Salvar HTML</button>
        <button id="showHTML" class="secondary">üëÅÔ∏è Ver HTML</button>
      </div>
      <div id="status">Aguardando HTML do editor...</div>
    </div>

    <iframe 
      id="email-editor-frame" 
      src="http://localhost:5173"
      title="Email Builder"
    ></iframe>
  </div>

  <script>
    let currentHTML = ''; // HTML COM metadados (salvar banco)
    let currentHTMLClean = ''; // HTML SEM metadados (enviar email)

    // ========================================
    // 1. RECEBER HTML DO IFRAME (em tempo real)
    // ========================================
    window.addEventListener('message', (event) => {
      // Em produ√ß√£o, valide o origin:
      // if (event.origin !== 'http://localhost:5173') return;
      
      if (event.data.type === 'EMAIL_HTML') {
        // HTML COM metadados (para salvar no banco)
        currentHTML = event.data.html;
        
        // HTML LIMPO sem metadados (para enviar email)
        currentHTMLClean = event.data.htmlClean;
        
        const size = (currentHTML.length / 1024).toFixed(2);
        document.getElementById('status').innerHTML = 
          `‚úÖ <strong>HTML atualizado:</strong> ${size} KB<br>
          <small>‚Ä¢ HTML completo: para salvar no banco</small><br>
          <small>‚Ä¢ HTML limpo: para enviar email</small>`;
      }
    });

    // ========================================
    // 2. ENVIAR HTML PARA O IFRAME
    // ========================================
    function enviarHTMLParaIframe(html) {
      const iframe = document.getElementById('email-editor-frame');
      
      iframe.contentWindow.postMessage({
        type: 'LOAD_EMAIL_HTML',
        html: html
      }, '*');
      
      document.getElementById('status').innerHTML = 
        '‚úÖ <strong>HTML carregado no editor!</strong>';
    }

    // ========================================
    // EXEMPLO 1: Email Simples (ser√° convertido em blocos)
    // ========================================
    document.getElementById('loadSimple').addEventListener('click', () => {
      const htmlSimples = `
        <h1 style="color: #0066FF; font-family: Arial, sans-serif; text-align: center;">
          Ol√° Mundo!
        </h1>
        <p style="color: #333; font-family: Arial, sans-serif; font-size: 16px; line-height: 1.5;">
          Este HTML ser√° automaticamente convertido em blocos edit√°veis: Heading, Text e Button.
        </p>
        <a href="https://example.com" 
           style="display: inline-block;
                  background-color: #0066FF;
                  color: white;
                  padding: 12px 24px;
                  text-decoration: none;
                  border-radius: 5px;
                  font-family: Arial, sans-serif;">
          Clique Aqui
        </a>
        <hr style="margin: 20px 0; border: 1px solid #ddd;" />
        <img src="https://via.placeholder.com/600x200" 
             alt="Imagem de exemplo" 
             style="width: 100%; max-width: 600px;" />
      `;
      
      enviarHTMLParaIframe(htmlSimples);
    });

    // ========================================
    // EXEMPLO 2: Simular carregar do banco (com metadados)
    // ========================================
    document.getElementById('loadFromDB').addEventListener('click', async () => {
      // Tenta carregar do localStorage primeiro
      const savedHTML = localStorage.getItem('emailTemplate');
      
      if (savedHTML) {
        console.log('üì• Carregando HTML salvo do localStorage...');
        enviarHTMLParaIframe(savedHTML);
        document.getElementById('status').innerHTML = 
          '‚úÖ <strong>Template carregado!</strong> Os blocos foram reconstru√≠dos perfeitamente.';
        return;
      }
      
      // Se n√£o tem salvo, usa exemplo com metadados embutidos
      const htmlComMetadados = `<!-- EMAIL_BUILDER_DATA:eyJyb290Ijp7InR5cGUiOiJFbWFpbExheW91dCIsImRhdGEiOnsiYmFja2Ryb3BDb2xvciI6IiNGNUY1RjUiLCJjYW52YXNDb2xvciI6IiNGRkZGRkYiLCJ0ZXh0Q29sb3IiOiIjMjYyNjI2IiwiZm9udEZhbWlseSI6Ik1PREVSTV9TQU5TIiwiY2hpbGRyZW5JZHMIKWIKASIIKX19LCJoZWFkaW5nLTEiOnLICJIZSI6IkhlYWRpbmciLCJkYXRhIjp7InN0eWxlIjp7ImNvbG9yIjoiIzMzMyIsInRleHRBbGlnbiI6ImNlbnRlciJ9LCJwcm9wcyI6eyJ0ZXh0IjoiRW1haWwgZG8gQmFuY28gZGUgRGFkb3MiLCJsZXZlbCI6ImgxIn19fSwidGV4dC0xIjp7InR5cGUIOiJUZXh0IiwiZGF0YSI6eyJzdHlsZSI6eyJjb2xvciI6IiM2NjYiLCJ0ZXh0QWxpZ24iOiJjZW50ZXIifSwicHJvcHMiOnsidGV4dCI6IkVzdGUgSFRNTCBmb2kgY2Fycn0gYWRvIGRvIGJhbmNvIGUgb3MgYmxvY29zIGZvcmFtIHJlY29uc3RydWlkb3MgcGVyZmVpdGFtZW50ZSEifX19LCJidXR0b24tMSI6eyJ0eXBlIjoiQnV0dG9uIiwiZGF0YSI6eyJzdHlsZSI6eyJiYWNrZ3JvdW5kQ29sb3IiOiIjMDA2NkZGIiwiY29sb3IiOiIjRkZGRkZGIiwidGV4dEFsaWduIjoiY2VudGVyIn0sInByb3BzIjp7InRleHQiOiJDb21lw6dhciBBZ29yYSIsInVybCI6Imh0dHBzOi8vZXhhbXBsZS5jb20ifX19fQ== -->
<!DOCTYPE html><html><body><div style="background-color: #f5f5f5; padding: 40px;"><div style="background-color: #ffffff; padding: 40px; max-width: 600px; margin: 0 auto;"><h1 style="color: #333; text-align: center;">Email do Banco de Dados</h1><p style="color: #666; text-align: center;">Este HTML foi carregado do banco e os blocos foram reconstru√≠dos perfeitamente!</p><div style="text-align: center;"><a href="https://example.com" style="display: inline-block; padding: 16px 40px; background-color: #0066FF; color: #ffffff; text-decoration: none;">Come√ßar Agora</a></div></div></div></body></html>`;
      
      enviarHTMLParaIframe(htmlComMetadados);
      document.getElementById('status').innerHTML = 
        '‚úÖ <strong>HTML do banco carregado!</strong> Os metadados permitiram reconstru√ß√£o perfeita dos blocos.';
    });

    // ========================================
    // 3. SALVAR HTML NO BANCO
    // ========================================
    document.getElementById('saveHTML').addEventListener('click', async () => {
      if (!currentHTML) {
        alert('‚ùå Nenhum HTML dispon√≠vel ainda. Aguarde o editor carregar.');
        return;
      }
      
      console.log('üì§ Salvando HTML COM metadados no banco...');
      console.log('Tamanho:', currentHTML.length, 'bytes');
      console.log('Conte√∫do:', currentHTML);
      
      // Em produ√ß√£o, voc√™ faria:
      /*
      try {
        const response = await fetch('/api/emails/save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            emailId: 123,
            conteudo: currentHTML  // ‚Üê HTML COM metadados
          })
        });
        
        alert('‚úÖ HTML salvo! Ao reabrir, todos os blocos estar√£o edit√°veis.');
      } catch (error) {
        alert('‚ùå Erro ao salvar: ' + error.message);
      }
      */
      
      // Simula salvar
      localStorage.setItem('emailTemplate', currentHTML);
      alert('‚úÖ HTML salvo no LocalStorage!\n\nQuando voc√™ reabrir, os blocos ser√£o reconstru√≠dos perfeitamente.');
      document.getElementById('status').innerHTML = 
        '‚úÖ <strong>HTML salvo!</strong> Clique em "Carregar do Banco" para testar a reconstru√ß√£o.';
    });

    // ========================================
    // 4. VISUALIZAR HTML
    // ========================================
    document.getElementById('showHTML').addEventListener('click', () => {
      if (!currentHTML) {
        alert('‚ùå Nenhum HTML dispon√≠vel ainda.');
        return;
      }
      
      // Abre em nova janela para visualizar
      const newWindow = window.open('', '_blank');
      newWindow.document.write(currentHTML);
      newWindow.document.close();
    });

    // ========================================
    // AUTO-SAVE (opcional)
    // ========================================
    let saveTimeout;
    
    window.addEventListener('message', (event) => {
      if (event.data.type === 'EMAIL_HTML') {
        currentHTML = event.data.html;
        
        // Cancela o timer anterior
        clearTimeout(saveTimeout);
        
        // Auto-save ap√≥s 3 segundos de inatividade
        saveTimeout = setTimeout(() => {
          console.log('üíæ Auto-salvando...');
          // Aqui voc√™ chamaria a API de save
        }, 3000);
      }
    });
  </script>
</body>
</html>
